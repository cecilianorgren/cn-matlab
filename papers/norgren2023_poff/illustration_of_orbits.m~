%% Define magnetic field
a = 5;
b = 1;
xvec = a*linspace(-10.1,10,500);
zvec = b*linspace(-10,10,100);
yvec = linspace(-0,0,1);

[X,Y,Z] = ndgrid(xvec,yvec,zvec);
%dx = x(2) - x(1);
%dy = y(2) - y(1);
%dz = z(2) - z(1);
%x_xline = x;
%y_xline = x*b/a;

Ay = @(x,y,z) (x/a).^2 - (z/b).^2;
AY0 = Ay(X,Y,Z);

Bx = @(x,y,z) 2*z/b^2;
Bz = @(x,y,z) 2*x/a^2;
%contour(X,Z,Ay(X,Z))
%hold on
%BX = Bx(X,Z);
%BZ = Bz(X,Z);
%quiver(X,Z,BX,BZ)

% Integrate orbits
m = 2;
q = -1;
Bx = @(x,y,z) 2*z/b^2;
By = @(x,y,z) x*0;
Bz = @(x,y,z) 2*x/a^2;
Ex = @(x,y,z) x*0;
Ey = @(x,y,z) x*0 + 0.1;
Ez = @(x,y,z) x*0;

options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,xvec([1 end])),...
                 'AbsTol',1e-6);
options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,[-40 40]),...
                 'AbsTol',1e-12);
EoM = @(t,xyz) eom(t,xyz,m,q,Ex,Ey,Ez,Bx,By,Bz); 
tstart = 0;
tstop = 1000;
% Good for y, but do not cross at the same z.
x_init_all = [-1 5 4 0 0 0;
              -18.1 0 -3.5 1 0 0
              18.1 -3 3.9 -1.18 0 0];
x_init_all = [-17.81 0 -3.5 1 0 0;
              -1 7 4 0 0 0;              
              18.1 -1.8 3.9 -1.18 0 0];
if 0 % other particles
x_init_all = [-1 5 4 0 0 0;
              -17.5 0 3.5 1 0 0
              18.1 -3 3.9 -1.2 0 0];
            
x_init_all = [-2 0 0.1 -1 -1 0;
              -2 0 0.1 -1 1 0
              -2 0 0.1 1 -1 0];
end

clear p
for ip = 1:size(x_init_all,1)
  x_init = x_init_all(ip,:);
  [t,x_sol] = ode45(EoM,[tstart tstop],x_init,options); % 
  p(ip).t = t;
  p(ip).x = x_sol(:,1);
  p(ip).y = x_sol(:,2);
  p(ip).z = x_sol(:,3);
  p(ip).vx = x_sol(:,4);
  p(ip).vy = x_sol(:,5);
  p(ip).vz = x_sol(:,6);
end

colors = pic_colors('matlab');
%colors = [colors(2)];
colors(3,:) = colors(1,:);
%colors(3,:) = colors(5,:).^0.5;
colors(1,:) = colors(1,:).^0.2;
linewidth = 1.5;

if 0 % Figure 1
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]); 
  %[C,H] = contour3()
  h1(1) = subplot(3,2,1);
  h1(2) = subplot(3,2,3);
  h1(3) = subplot(3,2,5);
  h2 = subplot(3,2,[2 4 6]);


  for ip = 1:numel(p)
    hca = h1(1);
    plot(hca,p(ip).t,p(ip).x)
    hold(hca,'on')

    hca = h1(2);
    plot(hca,p(ip).t,p(ip).y)
    hold(hca,'on')

    hca = h1(3);
    plot(hca,p(ip).t,p(ip).z)
    hold(hca,'on')
  end

  hold(h1(1),'off')
  hold(h1(2),'off')
  hold(h1(3),'off')

  hca = h2(1);
  %plot3(hca,1,1,1);
  plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot3(hca,p(ip).x,p(ip).y,p(ip).z)
  end
  hold(hca,'off')
  view(hca,[0 -1 0])
  %view(hca,[0 0 1])
  %axis(hca,'equal')
end

if 1 % Figure 2
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 2;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  %h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  holdon = 0;
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],hca.YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  drawnow
  grid on
  if 0  
  axis(h(1),'equal')
  axis(h(2),'equal')
  drawnow
  h(1).YLim = zlim;
  end
  %ylim = h(2).YLim;
  %axis(h(2),'equal')
  h(1).XLim = xlim;
  h(2).XLim = xlim;
  h(2).YLim = ylim;
  ylim = [-23 8];
  h(2).YLim = ylim;
  %h(1).XLim = xlim;
  %h(2).Position(4) = 0.7;
  %h(2).Position(4) = h(2).Position(3)*diff(ylim)/diff(xlim);
  axis(h(2),'equal')
  %h(2).Position(2) = 0.15;
  %compact_panels(0.01)
  h(1).Position(2) = h(2).Position(2)+h(2).Position(4)+0.01;
  h(1).Position(4) = 0.2;
  
  c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  h(2).XLabel.String = 'x';
  h(2).YLabel.String = 'y';
  h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
end

if 0 % Figure 3
  %%
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 3;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  irf_legend(hca,'X line',[0.65 0.1],'color',[0.5 0.5 0.5],'fontsize',14);
  
 
  
  
  hca = h(isub); isub = isub + 1;  
 
  
  plot(hca,[0 0],0.90*[-2 2],'--k')
 
  hold(hca,'on')
  
  for ip = 1:numel(p)
    %xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    ind = ind + 0;
    %ind = length(p(ip).x);
    
    tBx = Bx(p(ip).x,p(ip).y,p(ip).z);
    vxBz = p(ip).vx.*Bz(p(ip).x,p(ip).y,p(ip).z);
    vzBx = -p(ip).vz.*Bx(p(ip).x,p(ip).y,p(ip).z);
    
    vyBx = -p(ip).vy.*Bx(p(ip).x,p(ip).y,p(ip).z);
    tEy = -Ey(p(ip).x,p(ip).y,p(ip).z);
    toplot = 1*vxBz+1*vzBx;
    plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth);   
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
    
    tEy = -Ey(p(ip).x,p(ip).y,p(ip).z);
    toplot = 1*vxBz+0*vzBx;
    plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth);   
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
    
    
    plot(hca,xlim,-tEy(1)*[1 1],'color',[0.5 0.5 0.5],'linewidth',linewidth);
    %plot(hca,p(ip).t,vyBx,'color',colors(ip,:).^0.8,'linewidth',linewidth);   
    grid(hca,'on')
    
  end
  hca.XLabel.String = 'x';
  hca.YLabel.String = '-(v_zB_x-v_xB_z)';
  set(hca,'ColorOrder',[0.5 0.5 0.5])
  irf_legend(hca,'-E_y',[0.29 0.72],'color',[0.5 0.5 0.5],'fontsize',14);
  hold(hca,'off')
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],h(ip).YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  h(2).XLabel.String = 'x';
  h(2).YLabel.String = 'y';
  h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
  
  h(2).XGrid = 'on';
  h(2).YGrid = 'on';
  ylim = [-22.5 8];
  h(2).YLim = ylim;
  h(2).YTick = h(2).XTick;
  
  h(1).Position(2) = 0.72;
  h(2).Position(4) = 0.3;
  h(2).Position(1) = h(1).Position(1);
  h(2).Position(3) = h(1).Position(3);
  
  h(3).Position(2) = 0.2;
  h(3).Position(4) = 0.2;
  h(3).Position(1) = h(1).Position(1);
  h(3).Position(3) = h(1).Position(3);
  
  
  drawnow
  axis(h(2),'equal')
  h(2).YLim = ylim;
  
  %c_eval('h(?).XTick = []; h(?).YTick = [];',1:2)
  %c_eval('h(?).XTick = []; h(?).YTick = 0;',3)
  %%
  drawnow
  %ylim = h(2).YLim;
  axis(h(2),'equal')
  drawnow
  h(1).XLim = xlim;
  h(2).XLim = xlim;
  h(2).YLim = ylim;
  drawnow
  %h(1).XLim = xlim;
  %h(2).Position(4) = 0.7;
  %h(2).Position(4) = h(2).Position(3)*diff(ylim)/diff(xlim);
  axis(h(2),'equal')
  h(2).XLim = xlim;
  h(2).Position(3) = h(1).Position(3);
  %h(2).Position(2) = 0.15;
  %compact_panels(0.01)
  %h(1).Position(2) = h(2).Position(2)+h(2).Position(4)+0.01;
  %h(1).Position(4) = 0.2;
  %h(3).Position(2) = 0.2;
  
end


%% Add distributions (?)