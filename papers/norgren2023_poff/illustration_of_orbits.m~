%% xy
% Define magnetic field
a = 5;
b = 1;
xvec = a*linspace(-10.1,10,500);
zvec = b*linspace(-10,10,100);
yvec = linspace(-0,0,1);

[X,Y,Z] = ndgrid(xvec,yvec,zvec);
%dx = x(2) - x(1);
%dy = y(2) - y(1);
%dz = z(2) - z(1);
%x_xline = x;
%y_xline = x*b/a;

Ay = @(x,y,z) (x/a).^2 - (z/b).^2;
AY0 = Ay(X,Y,Z);

Bx = @(x,y,z) 2*z/b^2;
Bz = @(x,y,z) 2*x/a^2;
%contour(X,Z,Ay(X,Z))
%hold on
%BX = Bx(X,Z);
%BZ = Bz(X,Z);
%quiver(X,Z,BX,BZ)

% Integrate orbits
m = 2;
q = -1;
Bx = @(x,y,z) 2*z/b^2;
By = @(x,y,z) x*0;
Bz = @(x,y,z) 2*x/a^2;
Ex = @(x,y,z) x*0;
Ey = @(x,y,z) x*0 + 0.1;
Ez = @(x,y,z) x*0;

options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,xvec([1 end])),...
                 'AbsTol',1e-6);
options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,[-40 40]),...
                 'AbsTol',1e-12);
%options = odeset();
EoM = @(t,xyz) eom(t,xyz,m,q,Ex,Ey,Ez,Bx,By,Bz); 
tstart = 0;
tstop = 1000;
% Good for y, but do not cross at the same z.
x_init_all = [-1 5 4 0 0 0;
              -18.1 0 -3.5 1 0 0
              18.1 -3 3.9 -1.18 0 0];
x_init_all = [-17.81 0 -3.5 1 0 0;
              -1 7 4 0 0 0;              
              18.1 -1.8 3.9 -1.18 0 0];
if 0 % other particles
x_init_all = [-1 5 4 0 0 0;
              -17.5 0 3.5 1 0 0
              18.1 -3 3.9 -1.2 0 0];
            
x_init_all = [-2 0 0.1 -1 -1 0;
              -2 0 0.1 -1 1 0
              -2 0 0.1 1 -1 0];
end

clear p
for ip = 1:size(x_init_all,1)
  x_init = x_init_all(ip,:);
  [t,x_sol] = ode45(EoM,[tstart tstop],x_init,options); % 
  p(ip).t = t;
  p(ip).x = x_sol(:,1);
  p(ip).y = x_sol(:,2);
  p(ip).z = x_sol(:,3);
  p(ip).vx = x_sol(:,4);
  p(ip).vy = x_sol(:,5);
  p(ip).vz = x_sol(:,6);
end

colors = pic_colors('matlab');
%colors = [colors(2)];
colors(3,:) = colors(1,:);
%colors(3,:) = colors(5,:).^0.5;
colors(1,:) = colors(1,:).^0.2;
linewidth = 1.5;

if 0 % Figure 1
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]); 
  %[C,H] = contour3()
  h1(1) = subplot(3,2,1);
  h1(2) = subplot(3,2,3);
  h1(3) = subplot(3,2,5);
  h2 = subplot(3,2,[2 4 6]);


  for ip = 1:numel(p)
    hca = h1(1);
    plot(hca,p(ip).t,p(ip).x)
    hold(hca,'on')

    hca = h1(2);
    plot(hca,p(ip).t,p(ip).y)
    hold(hca,'on')

    hca = h1(3);
    plot(hca,p(ip).t,p(ip).z)
    hold(hca,'on')
  end

  hold(h1(1),'off')
  hold(h1(2),'off')
  hold(h1(3),'off')

  hca = h2(1);
  %plot3(hca,1,1,1);
  plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot3(hca,p(ip).x,p(ip).y,p(ip).z)
  end
  hold(hca,'off')
  view(hca,[0 -1 0])
  %view(hca,[0 0 1])
  %axis(hca,'equal')
end

if 1 % Figure 2
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 2;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  %h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  holdon = 0;
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],hca.YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  drawnow
  grid on
  if 0  
  axis(h(1),'equal')
  axis(h(2),'equal')
  drawnow
  h(1).YLim = zlim;
  end
  %ylim = h(2).YLim;
  %axis(h(2),'equal')
  h(1).XLim = xlim;
  h(2).XLim = xlim;
  h(2).YLim = ylim;
  ylim = [-23 8];
  h(2).YLim = ylim;
  %h(1).XLim = xlim;
  %h(2).Position(4) = 0.7;
  %h(2).Position(4) = h(2).Position(3)*diff(ylim)/diff(xlim);
  axis(h(2),'equal')
  %h(2).Position(2) = 0.15;
  %compact_panels(0.01)
  h(1).Position(2) = h(2).Position(2)+h(2).Position(4)+0.01;
  h(1).Position(4) = 0.2;
  
  c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  h(2).XLabel.String = 'x';
  h(2).YLabel.String = 'y';
  h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
end

if 0 % Figure 3
  %%
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 3;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  irf_legend(hca,'X line',[0.65 0.9],'color',[0.5 0.5 0.5],'fontsize',14);
  
 
  
  
  hca = h(isub); isub = isub + 1;  
 
  
  plot(hca,[0 0],0.90*[-2 2],'--k')
 
  hold(hca,'on')
  
  for ip = 1:numel(p)
    %xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    ind = ind + 0;
    %ind = length(p(ip).x);
    
    tBx = Bx(p(ip).x,p(ip).y,p(ip).z);
    vxBz = p(ip).vx.*Bz(p(ip).x,p(ip).y,p(ip).z);
    vzBx = -p(ip).vz.*Bx(p(ip).x,p(ip).y,p(ip).z);
    
    vyBx = -p(ip).vy.*Bx(p(ip).x,p(ip).y,p(ip).z);
    tEy = Ey(p(ip).x,p(ip).y,p(ip).z);
    
    toplot = 1*vxBz+1*vzBx;
    hh=plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth,'MarkerFaceColor',colors(ip,:));  
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
        
    toplot = 1*vxBz+0*vzBx;
    %plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth);   
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
    
    
    plot(hca,xlim,-tEy(1)*[1 1],'color',[0.5 0.5 0.5],'linewidth',linewidth);
    %plot(hca,p(ip).t,vyBx,'color',colors(ip,:).^0.8,'linewidth',linewidth);   
    grid(hca,'on')
    
  end
  hca.XLabel.String = 'x';
  hca.YLabel.String = '-(v_zB_x-v_xB_z)';
  set(hca,'ColorOrder',[0.5 0.5 0.5])
  irf_legend(hca,'-E_y',[0.29 0.72],'color',[0.5 0.5 0.5],'fontsize',14);
  hold(hca,'off')
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],h(ip).YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  h(2).XLabel.String = 'x';
  h(2).YLabel.String = 'y';
  h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
  
  h(2).XGrid = 'on';
  h(2).YGrid = 'on';
  ylim = [-22.5 8];
  %ylim = [-17 8];
  h(2).YLim = ylim;
  h(2).YTick = h(2).XTick;
  
  h(1).Position(2) = 0.72;
  h(2).Position(4) = 0.3;
  h(2).Position(1) = h(1).Position(1);
  h(2).Position(3) = h(1).Position(3);
  
  h(3).Position(2) = 0.2;
  h(3).Position(4) = 0.2;
  h(3).Position(1) = h(1).Position(1);
  h(3).Position(3) = h(1).Position(3);
  
  
  drawnow
  axis(h(2),'equal')
  h(2).YLim = ylim;
  
  c_eval('h(?).XTick = []; h(?).YTick = [];',1:2)
  c_eval('h(?).XTick = []; h(?).YTick = 0;',3)
h(2).Children = h(2).Children(end:-1:1);
  %%
  drawnow
  %ylim = h(2).YLim;
  axis(h(2),'equal')
  drawnow
  h(1).XLim = xlim;
  h(2).XLim = xlim;
  h(2).YLim = ylim;
  drawnow
  %h(1).XLim = xlim;
  %h(2).Position(4) = 0.7;
  %h(2).Position(4) = h(2).Position(3)*diff(ylim)/diff(xlim);
  axis(h(2),'equal')
  h(2).XLim = xlim;
  h(2).Position(3) = h(1).Position(3);
  %h(2).Position(2) = 0.15;
  %compact_panels(0.01)
  %h(1).Position(2) = h(2).Position(2)+h(2).Position(4)+0.01;
  %h(1).Position(4) = 0.2;
  %h(3).Position(2) = 0.2;
  
end

%% Add distributions (?)


%% yz
% Define magnetic field
a = 1.5*1e3;
b = 10*1e3;
xvec = a*linspace(-60,60,500);
zvec = b*linspace(-4,4,100);
yvec = linspace(-0,0,1);

[X,Y,Z] = ndgrid(xvec,yvec,zvec);
%dx = x(2) - x(1);
%dy = y(2) - y(1);
%dz = z(2) - z(1);
%x_xline = x;
%y_xline = x*b/a;



% Integrate orbits
B0 = 5;
E0 = 1;
m = 2;
q = -1;
lz = 3;

units = irf_units;
B0 = 5e-9;
E0 = 0.3e-3;
m = units.me;
q = -units.e;
lz = b;

Bx = @(x,y,z) B0*2*z/b^2;
Bx = @(x,y,z) B0*tanh(z/b);
By = @(x,y,z) B0*x*0;
Bz = @(x,y,z) B0*2*x/a^2;
Ex = @(x,y,z) E0*x*0;
Ey = @(x,y,z) E0*x*0 + E0;
Ez = @(x,y,z) 1*E0*-1*(z/(2*lz)).*exp(-(z/(2*lz)).^2);

Ay = @(x,y,z) (x/a).^2 - (z/b).^2;
Ay =  @(x,y,z) -b*B0*log(cosh(z/b)) + B0*(x/a).^2 + 0*y; %.*exp(-z.^2/b.^2)
AY0 = Ay(X,Y,Z);

Bx = @(x,y,z) 2*z/b^2;
Bz = @(x,y,z) 2*x/a^2;
%contour(X,Z,Ay(X,Z))
%hold on
%BX = Bx(X,Z);
%BZ = Bz(X,Z);
%quiver(X,Z,BX,BZ)

options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,xvec([1 end])),...
                 'AbsTol',1e-6);
%options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,1,0.1*a*[-1 1]),...
%                 'RelTol',1e-6,'AbsTol',1e-6);
options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,1,0.5*xvec([1 end])),...
                 'RelTol',1e-12,'AbsTol',1e-12);
EoM = @(t,xyz) eom(t,xyz,m,q,Ex,Ey,Ez,Bx,By,Bz); 
tstart = 0;
tstop = 0.01;

vz0 = E0/B0;
vt = 2*vz0;
x_init_all = [0.1*lz 0 -2*lz vt vt vz0 + vt;...
              %0.5 0 -4 0 0.0002 -0.0125;...
              ];

x_init_all = [-100 0 -20000 0.2*vz0 vt 0.1*vz0;...
              %0.5 0 -4 0 0.0002 -0.0125;...
              ];


clear p
for ip = 1:size(x_init_all,1)
  x_init = x_init_all(ip,:);
  [t,x_sol] = ode45(EoM,[tstart tstop],x_init,options); % 
  p(ip).t = t;
  p(ip).x = x_sol(:,1);
  p(ip).y = x_sol(:,2);
  p(ip).z = x_sol(:,3);
  p(ip).vx = x_sol(:,4);
  p(ip).vy = x_sol(:,5);
  p(ip).vz = x_sol(:,6);
end

colors = pic_colors('matlab');
%colors = [colors(2)];
colors(3,:) = colors(1,:);
%colors(3,:) = colors(5,:).^0.5;
colors(1,:) = colors(1,:).^0.2;
linewidth = 1.5;
% Figures

if 0 % Plot magnetic field structure
  %%
  figure(27)
  nrows = 3;
  ncols = 1;
  clear h
  ip = 0;
  for irow = 1:nrows
    for icols = 1:ncols
      ip = ip + 1;
      h(ip) = subplot(nrows,ncols,ip);
    end
  end
  
  isub = 1;
  if 1 % 2D Bx    
    hca = h(isub); isub = isub + 1;    
    pcolor(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Bx(squeeze(X),squeeze(Y),squeeze(Z))))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).y,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); hcb.YLabel.String = 'B_z';
  end
  if 1 % 2D Bz    
    hca = h(isub); isub = isub + 1;
    [X,Z] = ndgrid(xvec,zvec);
    pcolor(hca,X,Z,Bz(X,0,Z))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).y,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); hcb.YLabel.String = 'B_z';
  end
  if 1 % (x,y)
    hca = h(isub); isub = isub + 1;
    % Neutral plane
    %ylim = [min(p(1).y), max(p(1).y)];
    %plot(hca,ylim,[0 0],'k--');
    plot(hca,0,0)
    hold(hca,'on')

 
    for ip =[]% 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
    end
    for ip = 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      scatter(hca,p(ip).x,p(ip).y,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,colors([3 2],:))
    colormap(hca,color_topbot)
    colormap(hca,pic_colors('blue_red'))
    colormap(hca,[0 0 0;0.9 0.9 0.9])
    hold(hca,'off')  
    %hca.XLim = xlim;
    %hca.YLim = zlim;
    hca.XLabel.String = 'x';
    hca.YLabel.String = 'y';
  end
  
  if 0
    hca = h(isub); isub = isub + 1;
    plot(hca,zvec,Bx(0,0,zvec),zvec,Bz(0,0,zvec))
  end
  %colormap(pic_colors('blue_red'))
end
if 0 % Figure 1
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]); 
  %[C,H] = contour3()
  h1(1) = subplot(3,2,1);
  h1(2) = subplot(3,2,3);
  h1(3) = subplot(3,2,5);
  h2 = subplot(3,2,[2 4 6]);


  for ip = 1:numel(p)
    hca = h1(1);
    plot(hca,p(ip).t,p(ip).x)
    hold(hca,'on')

    hca = h1(2);
    plot(hca,p(ip).t,p(ip).y)
    hold(hca,'on')

    hca = h1(3);
    plot(hca,p(ip).t,p(ip).z)
    hold(hca,'on')
  end

  hold(h1(1),'off')
  hold(h1(2),'off')
  hold(h1(3),'off')

  hca = h2(1);
  %plot3(hca,1,1,1);
  plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot3(hca,p(ip).x,p(ip).y,p(ip).z)
  end
  hold(hca,'off')
  view(hca,[0 -1 0])
  %view(hca,[0 0 1])
  %axis(hca,'equal')
end
if 1 % Figure 2, illustration of twisted crescent for paper 
  %%
  if 0 % load data required for distribution
    %%
    tint = irf.tint('2017-07-11T22:31:00.00Z/2017-07-11T22:37:20.00Z'); %20151112071854
    ic = 3;
    c_eval('dmpaB? = mms.db_get_ts(''mms?_fgm_brst_l2'',''mms?_fgm_b_dmpa_brst_l2'',tint);',ic);
    c_eval('gseB? = mms.db_get_ts(''mms?_fgm_brst_l2'',''mms?_fgm_b_gse_brst_l2'',tint);',ic);
    c_eval('ePDist? = mms.get_data(''PDe_fpi_brst_l2'',tint,?);',ic)
    c_eval('gseVe? = mms.get_data(''Ve_gse_fpi_brst_l2'',tint,?);',ic)    
    c_eval('dbcsVe? = mms.get_data(''Ve_dbcs_fpi_brst_l2'',tint,?);',ic)
    c_eval('tic; scPot?=mms.db_get_ts(''mms?_edp_brst_l2_scpot'',''mms?_edp_scpot_brst_l2'',tint); toc;',ic);
    
    L = [0.9482,-0.255,-0.1893];
    M = [0.1818,0.9245,-0.3350];
    N = [0.2604,0.2832,0.9230];
    lmn = [L;M;N];
    
    c_eval('mvaB? = gseB?*lmn''; mvaB?.name = ''B LMN'';',ic)
    c_eval('mvaVe? = gseVe?*lmn''; mvaVe?.name = ''Ve LMN'';',ic)
    
  end
  figure(28)
  
  color_topbot = [colors(3,:); [.9 .9 .9]];
  %color_topbot = colormap(hca,[colors([3 2],:)]);
  %color_topbot = colormap(hca,[colors(3,:); colors(2,:).^0.1]);
    
  %colors = [0 0 0; colors];
    
  xmark = -4.58;
  %xlim = [-20 20];
  %zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z)))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z)))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 2;
  ncols = 2;
  clear h
  ip = 0;
  for irow = 1:nrows
    for icols = 1:ncols
      ip = ip + 1;
      h(irow,icols) = subplot(nrows,ncols,ip);
    end
  end
  h = h;

  isub = 1;
  
  if 0 % 2D Bx    
    hca = h(isub); isub = isub + 1;    
    pcolor(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Bx(squeeze(X),squeeze(Y),squeeze(Z))*1e9))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).z,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); 
    hcb.YLabel.String = 'B_x';
    colormap(hca,pic_colors('blue_red'))
  end
  if 0 % 2D Bz    
    hca = h(isub); isub = isub + 1;    
    pcolor(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Bz(squeeze(X),squeeze(Y),squeeze(Z))*1e9))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).z,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); 
    hcb.YLabel.String = 'B_z';
    colormap(hca,pic_colors('blue_red'))
  end
  
  if 1 % 2D Ay   
    hca = h(isub); isub = isub + 1;    
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')        
    hold(hca,'on')
    plot(hca,xvec*1e-3,xvec*0,'k--')
    hold(hca,'off')
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        %plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        scatter(hca,p(ip).x*1e-3,p(ip).z*1e-3,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      colormap(hca,colors([3 2],:))
      colormap(hca,color_topbot)
      hold(hca,'off')
    end       
    hca.XLabel.String = 'x';
    hca.YLabel.String = 'z'; 
    hca.XGrid = 'off';
    hca.YGrid = 'off';
    
    xlim = [min(p(1).x), max(p(1).x)];
    xlim = xlim + diff(xlim)*0.3*[-1 1];
    zlim = [min(p(1).z), max(p(1).z)];
    zlim = zlim + diff(zlim)*0.3*[-1 1];
    
    hca.XLim = xlim*1e-3;
    hca.YLim = zlim*1e-3;
  end
  
  if 0 % (x,y,z)
    hca = h(isub); isub = isub + 1;  
    
    plot3(hca,0,0,0);
    hold(hca,'on')
 
    for ip = 1:numel(p)
      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  if 0 % (x,y)
    hca = h(isub); isub = isub + 1;
    % Neutral plane
    %ylim = [min(p(1).y), max(p(1).y)];
    %plot(hca,ylim,[0 0],'k--');
    plot(hca,0,0)
    hold(hca,'on')

 
    for ip =[]% 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
    end
    for ip = 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      scatter(hca,p(ip).x,p(ip).y,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,colors([3 2],:))
    colormap(hca,color_topbot)
    hold(hca,'off')  
    %hca.XLim = xlim;
    %hca.YLim = zlim;
    hca.XLabel.String = 'x';
    hca.YLabel.String = 'y';
  end
  
  if 1 % (y,z)
    hca = h(isub); isub = isub + 1;
    % Neutral plane
    ylim = [min(p(1).y), max(p(1).y)];
    ylim = ylim + diff(ylim)*0.1*[-1 1];
    zlim = [min(p(1).z), max(p(1).z)];
    zlim = zlim + diff(zlim)*0.1*[-1 1];
    %if ylim(2) == 0; ylim(2) = 0.1*ylim(2); end
    %ylim(2) = -0.02*ylim(1);
    plot(hca,ylim,[0 0],'k--');
    hold(hca,'on')

 
    for ip =[]% 1:numel(p)
      plot(hca,p(ip).y(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).y(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).y*1e-3,p(ip).z*1e-3,'color',colors(ip,:),'linewidth',linewidth)
    end
    for ip = 1:numel(p)
      plot(hca,p(ip).y(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).y(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
      scatter(hca,p(ip).y*1e-3,p(ip).z*1e-3,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,colors([3 2],:))
    colormap(hca,color_topbot)
    hold(hca,'off')  
    %hca.XLim = xlim;
    %hca.YLim = zlim;
    hca.XLabel.String = 'y';
    hca.YLabel.String = 'z';
    hca.XLim = ylim*1e-3;
    hca.YLim = zlim*1e-3;
  end
  
  if 1 % phase space (vx,vy)
    hca = h(isub); isub = isub + 1;  
    holdon = 0;
    plot(hca,0,0)
    hold(hca,'on');
    for ip = 1:numel(p)
      plot(hca,p(ip).vy(1),   p(ip).vz(1),   'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).vy(end), p(ip).vz(end), 'Marker','x','color',colors(ip,:))
      %plot(hca,p(ip).vy,      p(ip).vz,                   'color',colors(ip,:),'linewidth',linewidth)
      scatter(hca,p(ip).vy*1e-3,p(ip).vz*1e-3,1,(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,pic_colors('blue_red'))
    colormap(hca,color_topbot)
    %hcb = colorbar(hca);
    %hcb.YLabel.String = 'z';
    hca.CLim = max(abs(hca.CLim))*[-1 1]*0.1;
    %plot(hca,[0 0],hca.YLim,'--k')
    for ip = []%1:numel(p)
      xq = xmark;
      yq = -0.7854;
      [ix] = find(p(ip).x>-10);
      [~,iy] = min(abs(p(ip).y(ix)-yq));
      %ind = intersect(ix,iy);
      ind = ix(iy);
      vs = 10;
      quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
    end

    hold(hca,'off')  
    axis(hca,'equal')
    axis(hca,'square')
    %hca.XLim = xlim; 
    hca.XLabel.String = 'v_y';
    hca.YLabel.String = 'v_z';
    vmax = max(abs([p(1).vy;p(1).vz]))*1e-3;
    hca.XLim = vmax*[-1 1];
    hca.YLim = vmax*[-1 1];
    hold(hca,'on')
    plot(hca,hca.XLim,[0 0],'k--')
    plot(hca,[0 0],hca.YLim,'k--')
    hold(hca,'off')
  end
  
  if 1 % add distribution from observations 
    times = EpochTT([...
      '2017-07-11T22:34:02.800000000Z';...
      '2017-07-11T22:34:03.300000000Z']);
    times = times(2) + 0.30*1;    
    dt_dist = 4*0.061; % for two distributions
    vint = [-Inf Inf];
    vint = [-20000 0000];
    %vint = [0000 20000];
    vg = -100000:2000:100000;
    elim = [100 Inf];
    
    for itime = 1:times.length
      hca = h(isub); isub = isub + 1;
      time = times(itime);
      % Reduce distributions
      
      c_eval('dist = ePDist?.elim(elim).tlim(time+0.5*dt_dist*[-1 1]*1); dist = dist(:);',ic)
      c_eval('scpot = scPot?.resample(dist);',ic)  
      c_eval('B = mvaB?.resample(dist);',ic)  
      c_eval('ve = mvaVe?.resample(dist);',ic)  
      vdf = dist.reduce('2D',M,N,'vint',vint,'scpot',scpot,'vg',vg);
      times_exact{itime} = vdf.time;

      % Plot
      %hca = h2(isub); isub = isub + 1;
      [ha_,hb_,hc_] = vdf.plot_plane(hca);      
      hc_.Colorbar.YLabel.String = sprintf('log_{10} f_e(v_%s,v_%s) (s^2/m^5)','y','z');
      hc_.Colorbar.YLabel.String = {sprintf('log_{10} f_e(v_%s,v_%s)','x','y'),'(s^2/m^5)'};
      colormap(hca,pic_colors('candy4'))   
      hca.XLabel.String = sprintf('v_%s (10^3 km/s)','y');
      hca.YLabel.String = sprintf('v_%s (10^3 km/s)','z');
      
     
      colormap(hca,pic_colors('candy4'))   
      axis(hca,'square');
      hca.XLim = [-60 60]*0.99;
      hca.YLim = [-60 60]*0.99;
      hca.XTick = -200:20:200;      
      hca.YTick = -200:20:200;   
      
      hca.CLim = [-14.8 -9.8];
      if 1 % add lines marking 0.
        %%
        hca.Color = 1*[1 1 1];
        hca.XGrid = 'off'; hca.YGrid = 'off';
        color_grid = 0.5*[1 1 1];
        hold(hca,"on"); plot(hca,vg*0,vg,'color',color_grid); plot(hca,vg,vg*0,'color',color_grid);

      end
      
      if 0 % plot B direction
        %%
        xlim = hca.XLim;
        ylim = hca.YLim;
        hold(hca,'on')
        %dt_distx = 0.030;
        %B_ = B.tlim(dist.time([1 end]) + 0.5*dt_dist*[-1 1]);
        B__ = B.tlim(dist.time([1 end]) + 0.5*0.03*[-1 1]);
        B_ = mean(B__.data,1);
        B_std = std(B__.data,1);
        b = B_/norm(B_);
        B_std_inplane = std(B__.data(:,2:3),1);
        B_inplane = sqrt(sum(B_(2:3).^2));
        if B_inplane > 2*norm(B_std_inplane)
          k = b(3)/b(2);
          if k > 1
            plot(hca,xlim,xlim*k,'k')
          else
            plot(hca,xlim/k,ylim,'k')
          end
          hold(hca,'off')
          hca.XLim = xlim;
          hca.YLim = ylim;
          B_ = B_(2:3);
      end
        irf_legend(hca,sprintf('B_{%s} = %.1f nT', comps,B_inplane),[0.02 0.98],'color','k','fontsize',fontsize_B_amp)

      end
      if 0 % plot bulk speed
        %%
        hold(hca,'on')
        plot(hca,mean(ve.(comps(1)).data,1)*1e-3,mean(ve.(comps(2)).data,1)*1e-3,'+k')
        plot(hca,mean(ve.(comps(1)).data,1)*1e-3,mean(ve.(comps(2)).data,1)*1e-3,'ow')
        hold(hca,'off')    
      end
     end
  end
  %hl = findobj(gcf,'type','line');
  for ip = []%1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],hca.YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  

  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  %c_eval('h(?).XGrid = ''on''; h(?).YGrid = ''on'';',1:numel(h))
  %c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:3)
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
  
  h(1).Position = [0.1218    0.5925    0.3347    0.3412];
  h(2).Position = [0.1218    0.1535    0.3347    0.3412];
  h(3).Position = [0.5403    0.5925    0.1605    0.3412];
  h(4).Position = [0.5403    0.1535    0.1605    0.3412];
  
end


if 0 % Figure 2 %
  %%
  figure(28)
  
  color_topbot = [colors(3,:); [.9 .9 .9]];
  %color_topbot = colormap(hca,[colors([3 2],:)]);
  %color_topbot = colormap(hca,[colors(3,:); colors(2,:).^0.1]);
    
  colors = [0 0 0; colors];
    
  xmark = -4.58;
  %xlim = [-20 20];
  %zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z)))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z)))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 4;
  ncols = 1;
  clear h
  ip = 0;
  for irow = 1:nrows
    for icols = 1:ncols
      ip = ip + 1;
      h(ip) = subplot(nrows,ncols,ip);
    end
  end
  

  isub = 1;
  
  if 0 % 2D Bx    
    hca = h(isub); isub = isub + 1;    
    pcolor(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Bx(squeeze(X),squeeze(Y),squeeze(Z))*1e9))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).z,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); 
    hcb.YLabel.String = 'B_x';
    colormap(hca,pic_colors('blue_red'))
  end
  if 0 % 2D Bz    
    hca = h(isub); isub = isub + 1;    
    pcolor(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Bz(squeeze(X),squeeze(Y),squeeze(Z))*1e9))
    shading(hca,'flat')
    clim = hca.CLim;
    hold(hca,'on')
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')
    hold(hca,'off')
    hca.CLim = clim;
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        %scatter(hca,p(ip).x,p(ip).z,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      hold(hca,'off')
    end
    hcb = colorbar(hca); 
    hcb.YLabel.String = 'B_z';
    colormap(hca,pic_colors('blue_red'))
  end
  
  if 1 % 2D Ay   
    hca = h(isub); isub = isub + 1;    
    contour(hca,squeeze(X)*1e-3,squeeze(Z)*1e-3,squeeze(Ay(squeeze(X),squeeze(Y),squeeze(Z))),10,'k')        
    if 1
      hold(hca,'on')
      for ip = 1:numel(p)
        plot(hca,p(ip).x(1)*1e-3,p(ip).z(1)*1e-3,'Marker','o','color',colors(ip,:))
        plot(hca,p(ip).x(end)*1e-3,p(ip).z(end)*1e-3,'Marker','x','color',colors(ip,:))
        %plot(hca,p(ip).x*1e-3,p(ip).z*1e-3,'color',colors(ip,:))
        scatter(hca,p(ip).x*1e-3,p(ip).z*1e-3,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
      end
      colormap(hca,colors([3 2],:))
      colormap(hca,color_topbot)
      hold(hca,'off')
    end       
    hca.XLabel.String = 'x';
    hca.YLabel.String = 'z'; 
  end
  
  if 0 % (x,y,z)
    hca = h(isub); isub = isub + 1;  
    
    plot3(hca,0,0,0);
    hold(hca,'on')
 
    for ip = 1:numel(p)
      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  if 1 % (x,y)
    hca = h(isub); isub = isub + 1;
    % Neutral plane
    %ylim = [min(p(1).y), max(p(1).y)];
    %plot(hca,ylim,[0 0],'k--');
    plot(hca,0,0)
    hold(hca,'on')

 
    for ip =[]% 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
    end
    for ip = 1:numel(p)
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      scatter(hca,p(ip).x,p(ip).y,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,colors([3 2],:))
    colormap(hca,color_topbot)
    hold(hca,'off')  
    %hca.XLim = xlim;
    %hca.YLim = zlim;
    hca.XLabel.String = 'x';
    hca.YLabel.String = 'y';
  end
  
  if 1 % (y,z)
    hca = h(isub); isub = isub + 1;
    % Neutral plane
    ylim = [min(p(1).y), max(p(1).y)];
    plot(hca,ylim,[0 0],'k--');
    hold(hca,'on')

 
    for ip =[]% 1:numel(p)
      plot(hca,p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).y,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    for ip = 1:numel(p)
      plot(hca,p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      scatter(hca,p(ip).y,p(ip).z,1,sign(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,colors([3 2],:))
    colormap(hca,color_topbot)
    hold(hca,'off')  
    %hca.XLim = xlim;
    %hca.YLim = zlim;
    hca.XLabel.String = 'y';
    hca.YLabel.String = 'z';
  end
  
  if 1 % phase space (vx,vy)
    hca = h(isub); isub = isub + 1;  
    holdon = 0;
    plot(hca,0,0)
    hold(hca,'on');
    for ip = 1:numel(p)
      plot(hca,p(ip).vy(1),   p(ip).vz(1),   'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).vy(end), p(ip).vz(end), 'Marker','x','color',colors(ip,:))
      %plot(hca,p(ip).vy,      p(ip).vz,                   'color',colors(ip,:),'linewidth',linewidth)
      scatter(hca,p(ip).vy,p(ip).vz,1,(p(ip).z),'Marker','.','linewidth',linewidth)
    end
    colormap(hca,pic_colors('blue_red'))
    colormap(hca,color_topbot)
    hcb = colorbar(hca);
    hcb.YLabel.String = 'z';
    hca.CLim = max(abs(hca.CLim))*[-1 1]*0.1;
    %plot(hca,[0 0],hca.YLim,'--k')
    for ip = []%1:numel(p)
      xq = xmark;
      yq = -0.7854;
      [ix] = find(p(ip).x>-10);
      [~,iy] = min(abs(p(ip).y(ix)-yq));
      %ind = intersect(ix,iy);
      ind = ix(iy);
      vs = 10;
      quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
    end

    hold(hca,'off')  
    axis(hca,'equal')
    axis(hca,'square')
    %hca.XLim = xlim; 
    hca.XLabel.String = 'v_y';
    hca.YLabel.String = 'v_z';
  end
  %hl = findobj(gcf,'type','line');
  for ip = []%1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],hca.YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  

  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XGrid = ''on''; h(?).YGrid = ''on'';',1:numel(h))
  %c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
end

if 0 % Figure 3
  %%
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 3;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  irf_legend(hca,'X line',[0.65 0.9],'color',[0.5 0.5 0.5],'fontsize',14);
  
 
  
  
  hca = h(isub); isub = isub + 1;  
 
  
  plot(hca,[0 0],0.90*[-2 2],'--k')
 
  hold(hca,'on')
  
  for ip = 1:numel(p)
    %xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    ind = ind + 0;
    %ind = length(p(ip).x);
    
    tBx = Bx(p(ip).x,p(ip).y,p(ip).z);
    vxBz = p(ip).vx.*Bz(p(ip).x,p(ip).y,p(ip).z);
    vzBx = -p(ip).vz.*Bx(p(ip).x,p(ip).y,p(ip).z);
    
    vyBx = -p(ip).vy.*Bx(p(ip).x,p(ip).y,p(ip).z);
    tEy = Ey(p(ip).x,p(ip).y,p(ip).z);
    
    toplot = 1*vxBz+1*vzBx;
    hh=plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth,'MarkerFaceColor',colors(ip,:));  
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
        
    toplot = 1*vxBz+0*vzBx;
    %plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth);   
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
    
    
    plot(hca,xlim,-tEy(1)*[1 1],'color',[0.5 0.5 0.5],'linewidth',linewidth);
    %plot(hca,p(ip).t,vyBx,'color',colors(ip,:).^0.8,'linewidth',linewidth);   
    grid(hca,'on')
    
  end
  hca.XLabel.String = 'x';
  hca.YLabel.String = '-(v_zB_x-v_xB_z)';
  set(hca,'ColorOrder',[0.5 0.5 0.5])
  irf_legend(hca,'-E_y',[0.29 0.72],'color',[0.5 0.5 0.5],'fontsize',14);
  hold(hca,'off')
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],h(ip).YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))

end

%% yz, pure xline with hall By
% Define magnetic field
a = 5;
b = 1;
xvec = a*linspace(-10.1,10,500);
zvec = b*linspace(-10,10,100);
yvec = linspace(-0,0,1);

[X,Y,Z] = ndgrid(xvec,yvec,zvec);
%dx = x(2) - x(1);
%dy = y(2) - y(1);
%dz = z(2) - z(1);
%x_xline = x;
%y_xline = x*b/a;

Ay = @(x,y,z) (x/a).^2 - (z/b).^2;
AY0 = Ay(X,Y,Z);

Bx = @(x,y,z) 2*z/b^2;
Bz = @(x,y,z) 2*x/a^2;
%contour(X,Z,Ay(X,Z))
%hold on
%BX = Bx(X,Z);
%BZ = Bz(X,Z);
%quiver(X,Z,BX,BZ)

% Integrate orbits
m = 2;
q = -1;
Bx = @(x,y,z) 2*z/b^2;
By = @(x,y,z) -3*x.*z/(a.^2*b.^2);
By = @(x,y,z) -1*(z/2/b).*exp(-(z/(2*b)).^2).*(x/2/a).*exp(-(x/(2*a)).^2);
Bz = @(x,y,z) 2*x/a^2;
Ex = @(x,y,z) x*0;
Ey = @(x,y,z) x*0 + 0.5;
Ez = @(x,y,z) x*0;
Ez = @(x,y,z) 1e4*E0*-1*(z/2/b).*exp(-(z/(2*b)).^2);

options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,xvec([1 end])),...
                 'AbsTol',1e-6);
%options = odeset('Events', @(t,xyz) eom_box_edge(t,xyz,[-40 40]),...
%                 'AbsTol',1e-12);
options = odeset();
EoM = @(t,xyz) eom(t,xyz,m,q,Ex,Ey,Ez,Bx,By,Bz); 
tstart = 0;
tstop = 50;
% Good for y, but do not cross at the same z.
x_init_all = [-1 5 4 0 0 0;
              -18.1 0 -3.5 1 0 0
              18.1 -3 3.9 -1.18 0 0];
x_init_all = [-17.81 0 -3.5 1 0 0;
              -1 7 4 0 0 0;              
              18.1 -1.8 3.9 -1.18 0 0];
if 0 % other particles
x_init_all = [-1 5 4 0 0 0;
              -17.5 0 3.5 1 0 0
              18.1 -3 3.9 -1.2 0 0];
            
x_init_all = [-2 0 0.1 -1 -1 0;
              -2 0 0.1 -1 1 0
              -2 0 0.1 1 -1 0];
end

x_init_all = [-17.81 0 -3.5 1 0 0;
              -0.1 5 -4 0 0 0;              
              18.1 -1.8 3.9 -1.18 0 0];
x_init_all = x_init_all(2,:);

clear p
for ip = 1:size(x_init_all,1)
  x_init = x_init_all(ip,:);
  [t,x_sol] = ode45(EoM,[tstart tstop],x_init,options); % 
  p(ip).t = t;
  p(ip).x = x_sol(:,1);
  p(ip).y = x_sol(:,2);
  p(ip).z = x_sol(:,3);
  p(ip).vx = x_sol(:,4);
  p(ip).vy = x_sol(:,5);
  p(ip).vz = x_sol(:,6);
end

colors = pic_colors('matlab');
%colors = [colors(2)];
colors(3,:) = colors(1,:);
%colors(3,:) = colors(5,:).^0.5;
colors(1,:) = colors(1,:).^0.2;
linewidth = 1.5;

if 0 % Figure 1
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]); 
  %[C,H] = contour3()
  h1(1) = subplot(3,2,1);
  h1(2) = subplot(3,2,3);
  h1(3) = subplot(3,2,5);
  h2 = subplot(3,2,[2 4 6]);


  for ip = 1:numel(p)
    hca = h1(1);
    plot(hca,p(ip).t,p(ip).x)
    hold(hca,'on')

    hca = h1(2);
    plot(hca,p(ip).t,p(ip).y)
    hold(hca,'on')

    hca = h1(3);
    plot(hca,p(ip).t,p(ip).z)
    hold(hca,'on')
  end

  hold(h1(1),'off')
  hold(h1(2),'off')
  hold(h1(3),'off')

  hca = h2(1);
  %plot3(hca,1,1,1);
  plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot3(hca,p(ip).x,p(ip).y,p(ip).z)
  end
  hold(hca,'off')
  view(hca,[0 -1 0])
  %view(hca,[0 0 1])
  %axis(hca,'equal')
end

if 1 % Figure 2
  %%
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 3;
  ncols = 2;
  clear h
  ip = 0;
  for irow = 1:nrows
    for icol = 1:ncols
      ip = ip + 1;
      h(ip) = subplot(nrows,ncols,ip);      
    end
  end

  isub = 1;
  
  if 0 % 3D
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)
      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  if 1 % (x,z) with Bx
    hca = h(isub); isub = isub + 1;
    % Separatrix
    plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
        
    hold(hca,'on')
    if 1 %  B
      Xpl = squeeze(X);
      Ypl = squeeze(Y);
      Zpl = squeeze(Z);
      pcolor(hca,Xpl,Zpl,Bx(Xpl,Ypl,Zpl))
      shading(hca,'flat');
      hcb = colorbar(hca);
      hcb.YLabel.String = 'B_x';
      colormap(hca,pic_colors('blue_red'))      
    end 
    for il = 1:numel(S) % Magnetic field lines
      plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p) % Particle trajectories
      plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    
    hold(hca,'off')
    hca.XLim = xlim;
    hca.YLim = zlim;
  end  
  if 1 % (x,z) with By
    hca = h(isub); isub = isub + 1;
    % Separatrix
    plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
        
    hold(hca,'on')
    if 1 %  B
      Xpl = squeeze(X);
      Ypl = squeeze(Y);
      Zpl = squeeze(Z);
      pcolor(hca,Xpl,Zpl,By(Xpl,Ypl,Zpl))
      shading(hca,'flat');
      hcb = colorbar(hca);
      hcb.YLabel.String = 'B_y';
      colormap(hca,pic_colors('blue_red'))      
    end 
    for il = 1:numel(S) % Magnetic field lines
      plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p) % Particle trajectories
      plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    
    hold(hca,'off')
    hca.XLim = xlim;
    hca.YLim = zlim;
  end
  if 1 % (x,z) with Bz
    hca = h(isub); isub = isub + 1;
    % Separatrix
    plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
        
    hold(hca,'on')
    if 1 %  Bz
      Xpl = squeeze(X);
      Ypl = squeeze(Y);
      Zpl = squeeze(Z);
      pcolor(hca,Xpl,Zpl,Bz(Xpl,Ypl,Zpl))
      shading(hca,'flat');
      hcb = colorbar(hca);
      hcb.YLabel.String = 'B_z';
      colormap(hca,pic_colors('blue_red'))
    end 
    for il = 1:numel(S) % Magnetic field lines
      plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p) % Particle trajectories
      plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    
    hold(hca,'off')
    hca.XLim = xlim;
    hca.YLim = zlim;
  end
  if 1 % (x,z) with Ez
    hca = h(isub); isub = isub + 1;
    % Separatrix
    plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
        
    hold(hca,'on')
    if 1 %  Bz
      Xpl = squeeze(X);
      Ypl = squeeze(Y);
      Zpl = squeeze(Z);
      pcolor(hca,Xpl,Zpl,Ez(Xpl,Ypl,Zpl))
      shading(hca,'flat');
      hcb = colorbar(hca);
      hcb.YLabel.String = 'E_z';
      colormap(hca,pic_colors('blue_red'))
    end 
    for il = 1:numel(S) % Magnetic field lines
      plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p) % Particle trajectories
      plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
    end
    
    hold(hca,'off')
    hca.XLim = xlim;
    hca.YLim = zlim;
  end
  if 0
    hca = h(isub); isub = isub + 1;  
    holdon = 0;
    plot(hca,0,0)
    hold(hca,'on');
    for ip = 1:numel(p)    
      plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
    end
    plot(hca,[0 0],hca.YLim,'--k')
    for ip = 1:numel(p)
      xq = xmark;
      yq = -0.7854;
      [ix] = find(p(ip).x>-10);
      [~,iy] = min(abs(p(ip).y(ix)-yq));
      %ind = intersect(ix,iy);
      ind = ix(iy);
      vs = 10;
      quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
    end

    hold(hca,'off')  
    %axis(hca,'equal')
    hca.XLim = xlim;  
  end
  if 1 % (vy,vz)
    hca = h(isub); isub = isub + 1;
    plot(hca,0,0)
    hold(hca,'on')
    for ip = 1:numel(p) % Particle trajectories
      plot(hca,p(ip).vy(1),p(ip).vz(1),'Marker','o','color',colors(ip,:))
      plot(hca,p(ip).vy(end),p(ip).vz(end),'Marker','x','color',colors(ip,:))
      plot(hca,p(ip).vy,p(ip).vz,'color',colors(ip,:),'linewidth',linewidth)
    end
    hold(hca,'off')
    axis(hca,'equal')
    hca.XGrid = 'on';
    hca.YGrid = 'on';
  end
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
 
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  drawnow
  grid on
  if 0  
  axis(h(1),'equal')
  axis(h(2),'equal')
  drawnow
  h(1).YLim = zlim;
  end
  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  %c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  %h(2).XLabel.String = 'x';
  %h(2).YLabel.String = 'y';
  %h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  %c_eval('h(?).LineWidth = 1;',1:numel(h))
end

if 0 % Figure 3
  %%
  xmark = -4.58;
  xlim = [-20 20];
  zlim = [-5 5];
  S = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[-105:10:110]);
  SX = contourcs(xvec,zvec,squeeze(Ay(X,Y,Z))',[0 0]-0.01); 
  %[C,H] = contour3()
  nrows = 3;
  ncols = 1;
  clear h
  h(1) = subplot(nrows,ncols,1);
  h(2) = subplot(nrows,ncols,2);
  h(3) = subplot(nrows,ncols,3);
  

  isub = 1;
  
  if 0
    hca = h(1); isub = isub + 1;  
    plot3(hca,SX(1).X,SX(1).X*0,SX(1).Y,'--k',SX(2).X,SX(2).X*0,SX(2).Y,'--k');
    hold(hca,'on')

    for il = 1:numel(S)
      plot3(hca,S(il).X,S(il).X*0,S(il).Y,'color',[0.5 0.5 0.5])
    end
    for ip = 1:numel(p)

      plot3(hca,p(ip).x(1),p(ip).y(1),p(ip).z(1),'Marker','o','color',colors(ip,:))
      plot3(hca,p(ip).x(end),p(ip).y(end),p(ip).z(end),'Marker','x','color',colors(ip,:))    
      plot3(hca,p(ip).x,p(ip).y,p(ip).z,'color',colors(ip,:))
    end
    hold(hca,'off')
    %view(hca,[0 -1 0])
    %view(hca,[0 0 1])
    %axis(hca,'equal')
  end
  
  hca = h(isub); isub = isub + 1;
  plot(hca,SX(1).X,SX(1).Y,'--k',SX(2).X,SX(2).Y,'--k');
  hold(hca,'on')

  for il = 1:numel(S)
    plot(hca,S(il).X,S(il).Y,'color',[0.5 0.5 0.5])
  end
  for ip = 1:numel(p)
    plot(hca,p(ip).x(1),p(ip).z(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).z(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).z,'color',colors(ip,:),'linewidth',linewidth)
  end
  hold(hca,'off')  
  hca.XLim = xlim;
  hca.YLim = zlim;
  %axis(hca,'equal')
  
  hca = h(isub); isub = isub + 1;  
  
  plot(hca,0,0)
  hold(hca,'on');
  for ip = 1:numel(p)    
    plot(hca,p(ip).x(1),p(ip).y(1),'Marker','o','color',colors(ip,:),'MarkerFaceColor',colors(ip,:))
    plot(hca,p(ip).x(end),p(ip).y(end),'Marker','x','color',colors(ip,:))
    plot(hca,p(ip).x,p(ip).y,'color',colors(ip,:),'linewidth',linewidth)
  end
  plot(hca,[0 0],hca.YLim,'--k')
  for ip = 1:numel(p)
    xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    vs = 10;
    quiver(hca,p(ip).x(ind),p(ip).y(ind),vs*p(ip).vx(ind),vs*p(ip).vy(ind),0,'color',colors(ip,:),'linewidth',1.5*linewidth)
  end
  
  hold(hca,'off')  
  %axis(hca,'equal')
  hca.XLim = xlim;  
  
  irf_legend(hca,'X line',[0.65 0.9],'color',[0.5 0.5 0.5],'fontsize',14);
  
 
  
  
  hca = h(isub); isub = isub + 1;  
 
  
  plot(hca,[0 0],0.90*[-2 2],'--k')
 
  hold(hca,'on')
  
  for ip = 1:numel(p)
    %xq = xmark;
    yq = -0.7854;
    [ix] = find(p(ip).x>-10);
    [~,iy] = min(abs(p(ip).y(ix)-yq));
    %ind = intersect(ix,iy);
    ind = ix(iy);
    ind = ind + 0;
    %ind = length(p(ip).x);
    
    tBx = Bx(p(ip).x,p(ip).y,p(ip).z);
    vxBz = p(ip).vx.*Bz(p(ip).x,p(ip).y,p(ip).z);
    vzBx = -p(ip).vz.*Bx(p(ip).x,p(ip).y,p(ip).z);
    
    vyBx = -p(ip).vy.*Bx(p(ip).x,p(ip).y,p(ip).z);
    tEy = Ey(p(ip).x,p(ip).y,p(ip).z);
    
    toplot = 1*vxBz+1*vzBx;
    hh=plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth,'MarkerFaceColor',colors(ip,:));  
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
        
    toplot = 1*vxBz+0*vzBx;
    %plot(hca,p(ip).x(1),toplot(1),'Marker','o','color',colors(ip,:),'linewidth',linewidth);   
    plot(hca,p(ip).x(1:ind),toplot(1:ind),'color',colors(ip,:),'linewidth',linewidth,'linestyle','-');
    
    
    plot(hca,xlim,-tEy(1)*[1 1],'color',[0.5 0.5 0.5],'linewidth',linewidth);
    %plot(hca,p(ip).t,vyBx,'color',colors(ip,:).^0.8,'linewidth',linewidth);   
    grid(hca,'on')
    
  end
  hca.XLabel.String = 'x';
  hca.YLabel.String = '-(v_zB_x-v_xB_z)';
  set(hca,'ColorOrder',[0.5 0.5 0.5])
  irf_legend(hca,'-E_y',[0.29 0.72],'color',[0.5 0.5 0.5],'fontsize',14);
  hold(hca,'off')
  
  %hl = findobj(gcf,'type','line');
  for ip = 1:numel(h)
    hold(h(ip),'on')
    plot(h(ip),xmark*[1 1],h(ip).YLim,':k')
    hold(h(ip),'off')
  end
  %c_eval('hl(?).LineWidth = 1;',1:numel(hl))
  
  
  %c_eval('h(?).XTickLabels = []; h(?).YTickLabels = [];',1:numel(h))
  c_eval('h(?).XTick = -40:5:40;',1:numel(h))
  h(2).XLabel.String = 'x';
  h(2).YLabel.String = 'y';
  h(1).YLabel.String = 'z';
  c_eval('h(?).FontSize = 14;',1:numel(h))
  c_eval('h(?).LineWidth = 1;',1:numel(h))
  
  h(2).XGrid = 'on';
  h(2).YGrid = 'on';
  ylim = [-22.5 8];
  %ylim = [-17 8];
  h(2).YLim = ylim;
  h(2).YTick = h(2).XTick;
  
  h(1).Position(2) = 0.72;
  h(2).Position(4) = 0.3;
  h(2).Position(1) = h(1).Position(1);
  h(2).Position(3) = h(1).Position(3);
  
  h(3).Position(2) = 0.2;
  h(3).Position(4) = 0.2;
  h(3).Position(1) = h(1).Position(1);
  h(3).Position(3) = h(1).Position(3);
  
  
  drawnow
  axis(h(2),'equal')
  h(2).YLim = ylim;
  
  c_eval('h(?).XTick = []; h(?).YTick = [];',1:2)
  c_eval('h(?).XTick = []; h(?).YTick = 0;',3)
h(2).Children = h(2).Children(end:-1:1);
  %%
  drawnow
  %ylim = h(2).YLim;
  axis(h(2),'equal')
  drawnow
  h(1).XLim = xlim;
  h(2).XLim = xlim;
  h(2).YLim = ylim;
  drawnow
  %h(1).XLim = xlim;
  %h(2).Position(4) = 0.7;
  %h(2).Position(4) = h(2).Position(3)*diff(ylim)/diff(xlim);
  axis(h(2),'equal')
  h(2).XLim = xlim;
  h(2).Position(3) = h(1).Position(3);
  %h(2).Position(2) = 0.15;
  %compact_panels(0.01)
  %h(1).Position(2) = h(2).Position(2)+h(2).Position(4)+0.01;
  %h(1).Position(4) = 0.2;
  %h(3).Position(2) = 0.2;
  
end
